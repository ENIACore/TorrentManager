
    def validate_nodes(self, node: Node) -> bool:
        """
        Recursively validate all nodes in the tree.
        Returns False if any node has UNKNOWN classification.
        """
        
        # Check current node
        if node.classification == 'UNKNOWN':
            logger.warning(f"Unknown classification for: {node.original_path}")
            return False
        
        # Recursively check all children
        for child in node.children_nodes:
            if not self.validate_nodes(child):
                return False
        
        return True

    def restructure_folder(self, node: Node) -> None:
        """Main restructuring function that delegates based on node classification"""
        if not node or not node.classification:
            return
        
        logger.info(f"Restructuring {node.classification}: {node.original_path}")
        
        # Handle different node types
        if node.classification == 'SERIES_FOLDER':
            self._restructure_series_folder(node)
        elif node.classification == 'SEASON_FOLDER':
            self._restructure_season_folder(node)
        elif node.classification == 'MOVIE_FOLDER':
            self._restructure_movie_folder(node)
        elif node.classification == 'MOVIE_FILE':
            self._restructure_movie_file(node)
        elif node.classification == 'EPISODE_FILE':
            self._restructure_episode_file(node)
        else:
            if node.original_path:
                self._move_to_error(node.original_path, "Invalid classification")

    def _restructure_series_folder(self, node: Node) -> None:
        """Restructure a series directory"""
        if not node.media_metadata or not node.media_metadata.title:
            logger.error(f"Series folder missing title: {node.original_path}")
            return
        
        # Create series directory
        series_name = str(node.media_metadata)
        series_dir = self.series_path / series_name
        series_dir.mkdir(exist_ok=True)
        
        logger.info(f"Created series directory: {series_dir}")
        
        # Process child nodes (seasons, etc.)
        for child in node.children_nodes:
            if child.classification == 'SEASON_DIR':
                self._restructure_season_folder(child, series_dir)
            elif child.classification in ['SUBTITLE_DIR', 'EXTRAS_DIR']:
                self._restructure_special_folder(child, series_dir)

    def _restructure_season_folder(self, node: Node, parent_dir: Path = None) -> None:
        """Restructure a season directory"""
        if not node.media_metadata:
            logger.error(f"Season folder missing metadata: {node.original_path}")
            return
        
        # Determine parent directory
        if parent_dir is None:
            # Try to get series name from parent or use title
            if node.parent_node and node.parent_node.media_metadata and node.parent_node.media_metadata.title:
                series_name = str(node.parent_node.media_metadata)
            elif node.media_metadata.title:
                series_name = str(node.media_metadata)
            else:
                series_name = "Unknown_Series"
            parent_dir = self.series_path / series_name
            parent_dir.mkdir(exist_ok=True)
        
        # Create season directory
        season_num = node.media_metadata.season if node.media_metadata.season else 0
        season_dir = parent_dir / f"Season_{str(season_num).zfill(2)}"
        season_dir.mkdir(exist_ok=True)
        
        logger.info(f"Created season directory: {season_dir}")
        
        # Process episode files
        for child in node.children_nodes:
            if child.classification == 'EPISODE_FILE':
                self._move_media_file(child, season_dir)
            elif child.classification == 'SUBTITLE_FILE':
                self._move_subtitle_file(child, season_dir)
            elif child.classification == 'SUBTITLE_DIR':
                self._restructure_subtitle_folder(child, season_dir)

    def _restructure_movie_folder(self, node: Node) -> None:
        """Restructure a movie directory"""
        if not node.media_metadata or not node.media_metadata.title:
            logger.error(f"Movie folder missing title: {node.original_path}")
            return
        
        # Create movie directory
        movie_name = str(node.media_metadata)
        movie_dir = self.movies_path / movie_name
        movie_dir.mkdir(exist_ok=True)
        
        logger.info(f"Created movie directory: {movie_dir}")
        
        # Process child files
        for child in node.children_nodes:
            if child.classification == 'MOVIE_FILE':
                self._move_media_file(child, movie_dir)
            elif child.classification == 'SUBTITLE_FILE':
                self._move_subtitle_file(child, movie_dir)
            elif child.classification == 'SUBTITLE_DIR':
                self._restructure_subtitle_folder(child, movie_dir)

    def _restructure_movie_file(self, node: Node) -> None:
        """Restructure a standalone movie file"""
        if not node.media_metadata or not node.media_metadata.title:
            logger.error(f"Movie file missing title: {node.original_path}")
            return
        
        # Create movie directory
        movie_name = str(node.media_metadata)
        movie_dir = self.movies_path / movie_name
        movie_dir.mkdir(exist_ok=True)
        
        # Move the movie file
        self._move_media_file(node, movie_dir)

    def _restructure_episode_file(self, node: Node) -> None:
        """Restructure a standalone episode file"""
        if not node.media_metadata:
            logger.error(f"Episode file missing metadata: {node.original_path}")
            return
        
        # Determine series and season
        series_name = str(node.media_metadata) if node.media_metadata.title else "Unknown_Series"
        season_num = node.media_metadata.season if node.media_metadata.season else 0
        
        # Create directory structure
        series_dir = self.series_path / series_name
        season_dir = series_dir / f"Season_{str(season_num).zfill(2)}"
        season_dir.mkdir(parents=True, exist_ok=True)
        
        # Move the episode file
        self._move_media_file(node, season_dir)

    def _restructure_subtitle_folder(self, node: Node, parent_dir: Path) -> None:
        """Restructure a subtitle directory"""
        subtitle_dir = parent_dir / "Subtitles"
        subtitle_dir.mkdir(exist_ok=True)
        
        for child in node.children_nodes:
            if child.classification == 'SUBTITLE_FILE':
                self._move_subtitle_file(child, subtitle_dir)

    def _restructure_special_folder(self, node: Node, parent_dir: Path) -> None:
        """Restructure extras or other special folders"""
        if node.classification == 'EXTRAS_DIR':
            special_dir = parent_dir / "Extras"
        elif node.classification == 'SUBTITLE_DIR':
            special_dir = parent_dir / "Subtitles"
        else:
            special_dir = parent_dir / node.original_path.name
        
        special_dir.mkdir(exist_ok=True)
        
        for child in node.children_nodes:
            if child.path_metadata and child.path_metadata.is_file:
                self._move_media_file(child, special_dir)

    def _move_media_file(self, node: Node, destination_dir: Path) -> None:
        """Move a media file to the destination directory with new name"""
        if not node.original_path or not node.path_metadata:
            return
        
        # Generate new filename
        if node.media_metadata:
            new_name = str(node.media_metadata)
            if node.path_metadata.ext:
                new_name += f".{node.path_metadata.ext}"
        else:
            new_name = node.original_path.name
        
        destination = destination_dir / new_name
        
        try:
            # Check if file already exists
            if destination.exists():
                logger.warning(f"File already exists, skipping: {destination}")
                return
            
            # Move the file
            shutil.move(str(node.original_path), str(destination))
            logger.info(f"Moved: {node.original_path} -> {destination}")
        except Exception as e:
            logger.error(f"Failed to move file {node.original_path}: {e}")

    def _move_subtitle_file(self, node: Node, destination_dir: Path) -> None:
        """Move a subtitle file to the destination directory"""
        if not node.original_path or not node.path_metadata:
            return
        
        # Create subtitles subdirectory
        subtitle_dir = destination_dir / "Subtitles"
        subtitle_dir.mkdir(exist_ok=True)
        
        self._move_media_file(node, subtitle_dir)

    def _move_to_error(self, path: Path, reason: str) -> None:
        """Move a file or directory to the error folder"""
        if not path.exists():
            return
        
        destination = self.error_path / path.name
        
        try:
            # Add number suffix if destination exists
            counter = 1
            while destination.exists():
                destination = self.error_path / f"{path.stem}_{counter}{path.suffix if path.is_file() else ''}"
                counter += 1
            
            shutil.move(str(path), str(destination))
            logger.warning(f"Moved to error: {path} -> {destination} (Reason: {reason})")
        except Exception as e:
            logger.error(f"Failed to move to error folder {path}: {e}")
